name: ðŸš€ Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: deploy

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ï¿½ Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ” Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸ’¾ Backup current state
        id: backup
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST 'bash -s' << 'ENDSSH'
            set -e
            
            cd /home/tristan/deploy/ATACCotheque || exit 1
            
            echo "ðŸ’¾ Saving current commit hash..."
            CURRENT_COMMIT=$(git rev-parse HEAD)
            echo "$CURRENT_COMMIT" > .last_deploy_commit
            echo "Previous commit: $CURRENT_COMMIT"
          ENDSSH

      - name: ðŸš€ Deploy to server
        id: deploy
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST 'bash -s' << 'ENDSSH'
            set -e
            
            echo "ðŸ“ Navigating to project directory..."
            cd /home/tristan/deploy/ATACCotheque || exit 1
            
            echo "ðŸ“¥ Pulling latest changes..."
            git pull origin main
            
            echo "ðŸ›‘ Stopping containers..."
            docker compose down
            
            echo "ðŸ—ï¸ Building and starting containers..."
            docker compose up -d --build
            
            echo "â³ Waiting for containers to be healthy..."
            sleep 10
            
            echo "ðŸ§¹ Cleaning up unused images..."
            docker image prune -af
            
            echo "âœ… Deployment completed successfully!"
          ENDSSH

      - name: ðŸ“Š Verify deployment
        id: verify
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST 'bash -s' << 'ENDSSH'
            set -e
            
            cd /home/tristan/deploy/ATACCotheque
            
            echo "ðŸ“Š Checking container status..."
            
            # VÃ©rifier que les conteneurs tournent
            RUNNING_CONTAINERS=$(docker compose ps -q | wc -l)
            if [ $RUNNING_CONTAINERS -eq 0 ]; then
              echo "âŒ No containers running!"
              exit 1
            fi
            
            echo "âœ… $RUNNING_CONTAINERS containers are running"
            
            # Afficher le statut
            docker compose ps
            
            # VÃ©rifier les logs pour des erreurs critiques
            if docker compose logs --tail=50 | grep -i "error\|fatal\|exception" | grep -v "health check"; then
              echo "âš ï¸ Errors detected in logs, but containers are running"
            fi
          ENDSSH

      - name: ðŸ”„ Rollback on failure
        if: failure() && steps.deploy.outcome == 'failure'
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST 'bash -s' << 'ENDSSH'
            set -e
            
            cd /home/tristan/deploy/ATACCotheque
            
            echo "ðŸ”„ Starting rollback process..."
            
            # RÃ©cupÃ©rer le commit prÃ©cÃ©dent
            if [ -f .last_deploy_commit ]; then
              PREVIOUS_COMMIT=$(cat .last_deploy_commit)
              echo "Rolling back to commit: $PREVIOUS_COMMIT"
              
              # Revenir au commit prÃ©cÃ©dent
              git reset --hard $PREVIOUS_COMMIT
              
              # RedÃ©marrer les conteneurs avec l'ancienne version
              docker compose down
              docker compose up -d --build
              
              echo "âœ… Rollback completed successfully"
            else
              echo "âŒ No previous commit found, cannot rollback"
              exit 1
            fi
          ENDSSH

      - name: ðŸŽ‰ Notify Discord - Success
        if: success()
        env:
          DISCORD_WEBHOOK: "https://discord.com/api/webhooks/1467945276525252618/a0q7puiyRnqgdMLKflBjEKPT4-q4hIrU0nhFU-kInP_nHdz-JNfzheQ-8CGIxUUZio9L"
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
          TIMESTAMP: ${{ github.event.head_commit.timestamp }}
        run: |
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"âœ… DÃ©ploiement rÃ©ussi\",
                \"description\": \"Le dÃ©ploiement sur le serveur de production a Ã©tÃ© effectuÃ© avec succÃ¨s.\",
                \"color\": 3066993,
                \"fields\": [
                  {
                    \"name\": \"ðŸ“¦ Repository\",
                    \"value\": \"${{ github.repository }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ðŸŒ¿ Branch\",
                    \"value\": \"${{ github.ref_name }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ðŸ‘¤ Author\",
                    \"value\": \"${{ github.actor }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ðŸ“ Commit\",
                    \"value\": \"\`\`\`${COMMIT_MESSAGE}\`\`\`\",
                    \"inline\": false
                  },
                  {
                    \"name\": \"ðŸ”— Commit URL\",
                    \"value\": \"[Voir le commit](${COMMIT_URL})\",
                    \"inline\": false
                  }
                ],
                \"timestamp\": \"${TIMESTAMP}\",
                \"footer\": {
                  \"text\": \"GitHub Actions â€¢ DÃ©ploiement\"
                },
                \"thumbnail\": {
                  \"url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\"
                }
              }]
            }" \
            "$DISCORD_WEBHOOK"

      - name: âŒ Notify Discord - Failure (No Rollback)
        if: failure() && steps.deploy.outcome == 'failure' && steps.backup.outcome == 'failure'
        env:
          DISCORD_WEBHOOK: "https://discord.com/api/webhooks/1467945276525252618/a0q7puiyRnqgdMLKflBjEKPT4-q4hIrU0nhFU-kInP_nHdz-JNfzheQ-8CGIxUUZio9L"
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          TIMESTAMP: ${{ github.event.head_commit.timestamp }}
          WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"âŒ Ã‰chec du dÃ©ploiement\",
                \"description\": \"Le dÃ©ploiement a Ã©chouÃ© avant la phase de backup. Aucun rollback possible.\",
                \"color\": 15158332,
                \"fields\": [
                  {
                    \"name\": \"ðŸ“¦ Repository\",
                    \"value\": \"${{ github.repository }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ðŸŒ¿ Branch\",
                    \"value\": \"${{ github.ref_name }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ðŸ‘¤ Author\",
                    \"value\": \"${{ github.actor }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ðŸ“ Commit\",
                    \"value\": \"\`\`\`${COMMIT_MESSAGE}\`\`\`\",
                    \"inline\": false
                  },
                  {
                    \"name\": \"ðŸ”— Workflow Run\",
                    \"value\": \"[Voir les logs](${WORKFLOW_URL})\",
                    \"inline\": false
                  }
                ],
                \"timestamp\": \"${TIMESTAMP}\",
                \"footer\": {
                  \"text\": \"GitHub Actions â€¢ Ã‰chec\"
                }
              }]
            }" \
            "$DISCORD_WEBHOOK"

      - name: ðŸ”„ Notify Discord - Rollback Success
        if: failure() && steps.deploy.outcome == 'failure' && steps.backup.outcome == 'success'
        env:
          DISCORD_WEBHOOK: "https://discord.com/api/webhooks/1467945276525252618/a0q7puiyRnqgdMLKflBjEKPT4-q4hIrU0nhFU-kInP_nHdz-JNfzheQ-8CGIxUUZio9L"
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          TIMESTAMP: ${{ github.event.head_commit.timestamp }}
          WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ðŸ”„ Rollback effectuÃ©\",
                \"description\": \"Le dÃ©ploiement a Ã©chouÃ©. Un rollback automatique a Ã©tÃ© effectuÃ© vers la version prÃ©cÃ©dente.\",
                \"color\": 16776960,
                \"fields\": [
                  {
                    \"name\": \"ðŸ“¦ Repository\",
                    \"value\": \"${{ github.repository }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ðŸŒ¿ Branch\",
                    \"value\": \"${{ github.ref_name }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ðŸ‘¤ Author\",
                    \"value\": \"${{ github.actor }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ðŸ“ Commit ayant Ã©chouÃ©\",
                    \"value\": \"\`\`\`${COMMIT_MESSAGE}\`\`\`\",
                    \"inline\": false
                  },
                  {
                    \"name\": \"âš ï¸ Action requise\",
                    \"value\": \"VÃ©rifiez les logs et corrigez les erreurs avant de redÃ©ployer.\",
                    \"inline\": false
                  },
                  {
                    \"name\": \"ðŸ”— Workflow Run\",
                    \"value\": \"[Voir les logs](${WORKFLOW_URL})\",
                    \"inline\": false
                  }
                ],
                \"timestamp\": \"${TIMESTAMP}\",
                \"footer\": {
                  \"text\": \"GitHub Actions â€¢ Rollback\"
                }
              }]
            }" \
            "$DISCORD_WEBHOOK"

      - name: âŒ Notify Discord - Verification Failed
        if: failure() && steps.verify.outcome == 'failure' && steps.deploy.outcome == 'success'
        env:
          DISCORD_WEBHOOK: "https://discord.com/api/webhooks/1467945276525252618/a0q7puiyRnqgdMLKflBjEKPT4-q4hIrU0nhFU-kInP_nHdz-JNfzheQ-8CGIxUUZio9L"
          TIMESTAMP: ${{ github.event.head_commit.timestamp }}
          WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"âš ï¸ DÃ©ploiement avec avertissement\",
                \"description\": \"Le dÃ©ploiement est terminÃ© mais la vÃ©rification a dÃ©tectÃ© des problÃ¨mes.\",
                \"color\": 16776960,
                \"fields\": [
                  {
                    \"name\": \"ðŸ“¦ Repository\",
                    \"value\": \"${{ github.repository }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ðŸŒ¿ Branch\",
                    \"value\": \"${{ github.ref_name }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ðŸ‘¤ Author\",
                    \"value\": \"${{ github.actor }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"âš ï¸ Status\",
                    \"value\": \"Les conteneurs ne rÃ©pondent pas comme prÃ©vu. VÃ©rification manuelle requise.\",
                    \"inline\": false
                  },
                  {
                    \"name\": \"ðŸ”— Workflow Run\",
                    \"value\": \"[Voir les logs](${WORKFLOW_URL})\",
                    \"inline\": false
                  }
                ],
                \"timestamp\": \"${TIMESTAMP}\",
                \"footer\": {
                  \"text\": \"GitHub Actions â€¢ Avertissement\"
                }
              }]
            }" \
            "$DISCORD_WEBHOOK"
